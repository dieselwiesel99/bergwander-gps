<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<title>GPS Bergwander Pro</title>
<meta name="description" content="Professionelle GPS-Tracking App fÃ¼r Bergwanderungen mit Live-Wetter, Warnungen und Route-Aufzeichnung">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="GPS Bergwander">
<meta name="theme-color" content="#667eea">
<link rel="apple-touch-icon" href="icon.png">
<link rel="icon" type="image/png" href="icon.png">
<link rel="manifest" href="manifest.json">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<style>
*{box-sizing:border-box;margin:0;padding:0}
body{
font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Helvetica,Arial,sans-serif;
background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);
min-height:100vh;
padding:15px;
color:#fff;
-webkit-font-smoothing:antialiased;
-moz-osx-font-smoothing:grayscale;
}
.container{max-width:700px;margin:0 auto;padding-bottom:30px}
.card{
background:#fff;
color:#333;
border-radius:18px;
padding:22px;
margin:14px 0;
box-shadow:0 10px 40px rgba(0,0,0,0.2);
}
h1{
font-size:1.8em;
color:#667eea;
text-align:center;
font-weight:800;
margin-bottom:12px;
letter-spacing:-0.5px;
}
.btn{
background:linear-gradient(135deg,#667eea,#764ba2);
color:#fff;
border:none;
padding:16px 22px;
border-radius:14px;
font-size:1.05em;
font-weight:700;
width:100%;
cursor:pointer;
margin:10px 0;
transition:transform 0.2s,box-shadow 0.2s;
text-decoration:none;
display:block;
text-align:center;
-webkit-tap-highlight-color:transparent;
box-shadow:0 4px 15px rgba(102,126,234,0.3);
}
.btn:active{transform:scale(0.97);box-shadow:0 2px 8px rgba(102,126,234,0.4)}
.btn.secondary{
background:linear-gradient(135deg,#f093fb,#f5576c);
padding:13px 18px;
font-size:0.95em;
box-shadow:0 4px 15px rgba(245,87,108,0.3);
}
.btn.sos{
background:linear-gradient(135deg,#ff4444,#cc0000);
font-size:1.2em;
animation:sosAnim 2.5s infinite;
box-shadow:0 8px 30px rgba(255,68,68,0.5);
}
@keyframes sosAnim{
0%,100%{box-shadow:0 8px 30px rgba(255,68,68,0.5);transform:scale(1)}
50%{box-shadow:0 8px 45px rgba(255,68,68,0.8);transform:scale(1.02)}
}
.btn.success{
background:linear-gradient(135deg,#11998e,#38ef7d);
box-shadow:0 4px 15px rgba(56,239,125,0.3);
}
.status{
padding:15px;
border-radius:14px;
margin:12px 0;
font-weight:700;
text-align:center;
font-size:0.95em;
}
.loading{background:#e3f2fd;color:#1976d2}
.success{background:#e8f5e9;color:#2e7d32}
.error{background:#ffebee;color:#c62828}
.warning{background:#fff3e0;color:#e65100}
.alert{
background:linear-gradient(135deg,#ff5722,#e64a19);
color:#fff;
padding:16px;
border-radius:14px;
margin:14px 0;
font-weight:800;
animation:alertPulse 2s infinite;
box-shadow:0 6px 25px rgba(255,87,34,0.5);
font-size:1.05em;
}
@keyframes alertPulse{
0%,100%{opacity:1;transform:scale(1)}
50%{opacity:0.92;transform:scale(1.015)}
}
.grid{
display:grid;
grid-template-columns:1fr 1fr;
gap:12px;
margin:14px 0;
}
.box{
background:#f9fafb;
padding:16px;
border-radius:12px;
border:3px solid #667eea;
text-align:center;
transition:transform 0.2s;
}
.box:active{transform:scale(0.98)}
.box strong{
display:block;
font-size:1.6em;
margin:8px 0;
color:#667eea;
font-weight:800;
}
.box.green{border-color:#4caf50}
.box.green strong{color:#4caf50}
.box.blue{border-color:#2196f3}
.box.blue strong{color:#2196f3}
.box.red{border-color:#f5576c}
.box.red strong{color:#f5576c}
.box.orange{border-color:#ff9800}
.box.orange strong{color:#ff9800}
.big-display{
text-align:center;
padding:18px;
background:#f9fafb;
border-radius:14px;
margin:14px 0;
}
.big-num{
font-size:2.8em;
font-weight:900;
color:#f5576c;
margin:10px 0;
letter-spacing:-1px;
}
.label{
font-size:0.88em;
color:#666;
margin:5px 0;
font-weight:600;
}
#map{
width:100%;
height:320px;
border-radius:14px;
margin:14px 0;
border:4px solid #667eea;
box-shadow:0 6px 20px rgba(0,0,0,0.15);
}
.compass{
text-align:center;
font-size:6em;
margin:18px 0;
transition:transform 0.6s ease;
filter:drop-shadow(0 6px 12px rgba(0,0,0,0.25));
}
.waypoint-item{
background:#f9fafb;
padding:14px;
border-radius:12px;
margin:10px 0;
border-left:6px solid #667eea;
transition:transform 0.2s;
}
.waypoint-item:active{transform:translateX(4px)}
.waypoint-item strong{color:#667eea;font-size:1.1em}
.elevation-chart{
background:#f9fafb;
padding:16px;
border-radius:14px;
margin:14px 0;
}
.modal{
display:none;
position:fixed;
top:0;
left:0;
width:100%;
height:100%;
background:rgba(0,0,0,0.9);
z-index:9999;
align-items:center;
justify-content:center;
padding:20px;
}
.modal-content{
background:#fff;
padding:30px;
border-radius:22px;
max-width:450px;
width:100%;
color:#333;
max-height:92vh;
overflow-y:auto;
box-shadow:0 15px 60px rgba(0,0,0,0.4);
}
.modal h2{
color:#cc0000;
margin-bottom:20px;
font-size:1.8em;
font-weight:800;
}
.modal input{
width:100%;
padding:16px;
margin:14px 0;
border-radius:12px;
border:3px solid #e0e0e0;
font-size:1.05em;
transition:border-color 0.2s;
}
.modal input:focus{
border-color:#667eea;
outline:none;
}
.section-title{
font-weight:800;
color:#667eea;
margin:18px 0 12px;
font-size:1.15em;
text-align:center;
letter-spacing:-0.3px;
}
.info{
background:#e3f2fd;
color:#1976d2;
padding:12px;
border-radius:12px;
font-size:0.9em;
margin:12px 0;
text-align:center;
font-weight:600;
}
.hidden{display:none!important}
@media(max-width:480px){
h1{font-size:1.6em}
.btn{font-size:1em;padding:14px 18px}
.big-num{font-size:2.4em}
#map{height:280px}
}
</style>
</head>
<body>
<div class="container">
<div class="card">
<h1>ğŸ”ï¸ GPS Bergwander Pro</h1>
<div id="status" class="status loading">ğŸ” GPS wird initialisiert...</div>
</div>

<div id="weatherCard"></div>
<div id="compass" class="compass hidden">ğŸ§­</div>
<div id="mapContainer"></div>

<div id="distanceCard" class="card hidden">
<div class="big-display">
<div class="label">ğŸš¶ ZurÃ¼ckgelegte Strecke</div>
<div class="big-num" id="distance">0 m</div>
</div>
</div>

<div id="statsCard" class="card hidden">
<div class="section-title">ğŸ“Š Live-Statistiken</div>
<div id="stats"></div>
</div>

<div id="elevationCard" class="card hidden">
<div class="section-title">ğŸ“ˆ HÃ¶henprofil</div>
<div id="elevation" class="elevation-chart"></div>
</div>

<div id="positionCard" class="card hidden">
<div class="section-title">ğŸ“ Aktuelle Position</div>
<div id="position"></div>
</div>

<div id="waypointsCard" class="card hidden">
<div class="section-title">ğŸ“Œ Wegpunkte (<span id="wpCount">0</span>)</div>
<div id="waypoints"></div>
</div>

<div class="card">
<button class="btn sos" id="sosBtn">ğŸ†˜ NOTRUF (112)</button>
<div id="initialControls">
<button class="btn" id="startBtn">ğŸ“ Live-Tracking starten</button>
</div>
<div id="activeControls" class="hidden">
<button class="btn secondary" id="wpBtn">ğŸ“Œ Wegpunkt setzen</button>
<button class="btn secondary" id="copyBtn">ğŸ“‹ Koordinaten kopieren</button>
<a class="btn secondary" id="mapsBtn" href="#" target="_blank" style="display:none">ğŸ—ºï¸ In Google Maps</a>
<a class="btn secondary" id="routeBtn" href="#" target="_blank" style="display:none">ğŸ—ºï¸ Route in Maps</a>
<button class="btn success" id="pauseBtn">â¸ï¸ Tracking pausieren</button>
<button class="btn" id="resetBtn" style="background:#666">ğŸ”„ Alles zurÃ¼cksetzen</button>
</div>
<div class="info">ğŸ’¡ Mit Live-Wetter & Warnungen â€¢ iPhone-optimiert</div>
</div>
</div>

<div id="sosModal" class="modal">
<div class="modal-content">
<h2>ğŸ†˜ NOTRUF</h2>
<p style="margin:12px 0;font-weight:600">Deine aktuelle Position:</p>
<p id="sosCoords" style="font-size:1.2em;margin:14px 0;color:#667eea;font-weight:700"></p>
<input type="tel" id="sosPhone" placeholder="Kontakt-Nummer (optional)" autocomplete="tel">
<button class="btn sos" id="sosSMS">ğŸ“± SMS mit Position senden</button>
<button class="btn secondary" id="sosCall">ğŸ“ 112 anrufen</button>
<button class="btn" id="sosClose" style="background:#666">Abbrechen</button>
</div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
'use strict';
const APP={
tracking:false,watchId:null,
pos:{lat:0,lon:0,alt:null,acc:0,speed:null,heading:null},
lastPos:null,route:[],elevations:[],waypoints:[],
stats:{start:null,dist:0,maxSpeed:0,maxAlt:-Infinity,minAlt:Infinity,ascent:0,descent:0,lastAlt:null},
map:null,marker:null,line:null,weatherTimer:null,statsTimer:null,lastWeatherCheck:0,

init(){
console.log('ğŸ”ï¸ GPS Bergwander Pro v8.1 - Optimiert mit Custom Icon');
this.bindEvents();
this.getGPS();
},

bindEvents(){
document.getElementById('startBtn').onclick=()=>this.start();
document.getElementById('pauseBtn').onclick=()=>this.pause();
document.getElementById('resetBtn').onclick=()=>this.reset();
document.getElementById('sosBtn').onclick=()=>this.openSOS();
document.getElementById('wpBtn').onclick=()=>this.addWP();
document.getElementById('copyBtn').onclick=()=>this.copy();
document.getElementById('sosClose').onclick=()=>this.closeSOS();
document.getElementById('sosSMS').onclick=()=>this.sendSMS();
document.getElementById('sosCall').onclick=()=>this.call112();
},

getGPS(){
if(!navigator.geolocation){
this.setStatus('error','âŒ GPS nicht verfÃ¼gbar');
return;
}
this.setStatus('loading','ğŸ” GPS-Signal wird gesucht...');
navigator.geolocation.getCurrentPosition(
p=>this.onGPS(p,false),
e=>this.onError(e),
{enableHighAccuracy:true,timeout:30000,maximumAge:10000}
);
},

start(){
if(this.tracking)return;
this.tracking=true;
this.stats.start=Date.now();
document.getElementById('initialControls').classList.add('hidden');
document.getElementById('activeControls').classList.remove('hidden');
this.setStatus('warning','ğŸ“¡ Live-Tracking aktiv...');
this.watchId=navigator.geolocation.watchPosition(
p=>this.onGPS(p,true),
e=>this.onError(e),
{enableHighAccuracy:true,maximumAge:0,timeout:30000}
);
this.statsTimer=setInterval(()=>this.updateStats(),5000);
this.weatherTimer=setInterval(()=>this.getWeather(),10*60*1000);
},

pause(){
this.tracking=false;
if(this.watchId){
navigator.geolocation.clearWatch(this.watchId);
this.watchId=null;
}
clearInterval(this.statsTimer);
clearInterval(this.weatherTimer);
document.getElementById('initialControls').classList.remove('hidden');
document.getElementById('activeControls').classList.add('hidden');
document.getElementById('startBtn').innerHTML='â–¶ï¸ Fortsetzen';
this.setStatus('success','â¸ï¸ Pausiert');
},

onGPS(position,tracking){
const c=position.coords;
this.pos={lat:c.latitude,lon:c.longitude,alt:c.altitude,acc:Math.round(c.accuracy),speed:c.speed,heading:c.heading};

if(!this.map){
this.initMap();
this.getWeather();
}

if(tracking && this.lastPos){
const d=this.dist(this.lastPos.lat,this.lastPos.lon,this.pos.lat,this.pos.lon);
if(d>=5 && d<=100){
this.stats.dist+=d;
this.route.push([this.pos.lat,this.pos.lon]);
this.updateLine();
}
}else if(!this.route.length){
this.route.push([this.pos.lat,this.pos.lon]);
}

if(this.pos.alt!==null){
this.elevations.push(this.pos.alt);
if(this.pos.alt>this.stats.maxAlt)this.stats.maxAlt=this.pos.alt;
if(this.pos.alt<this.stats.minAlt)this.stats.minAlt=this.pos.alt;
if(this.stats.lastAlt!==null){
const diff=this.pos.alt-this.stats.lastAlt;
if(diff>0)this.stats.ascent+=diff;
else this.stats.descent+=Math.abs(diff);
}
this.stats.lastAlt=this.pos.alt;
this.drawElevation();
}

if(this.pos.speed!==null && this.pos.speed>0){
const kmh=this.pos.speed*3.6;
if(kmh>this.stats.maxSpeed)this.stats.maxSpeed=kmh;
}

this.lastPos={...this.pos};
this.setStatus('success','âœ… Position aktualisiert');
this.render();
},

onError(err){
let msg='âŒ GPS-Fehler';
if(err.code===1)msg='âŒ Standort verweigert<br><small>Einstellungen â†’ Standort erlauben</small>';
if(err.code===2)msg='âŒ Position nicht verfÃ¼gbar<br><small>Gehe nach drauÃŸen</small>';
if(err.code===3)msg='â±ï¸ Timeout<br><small>Erneut versuchen...</small>';
this.setStatus('error',msg);
},

initMap(){
const div=document.createElement('div');
div.id='map';
document.getElementById('mapContainer').appendChild(div);
this.map=L.map('map').setView([this.pos.lat,this.pos.lon],15);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{attribution:'Â© OpenStreetMap',maxZoom:19}).addTo(this.map);
this.marker=L.marker([this.pos.lat,this.pos.lon],{icon:L.divIcon({className:'',html:'ğŸ“',iconSize:[34,34]})}).addTo(this.map);
this.line=L.polyline([],{color:'#f5576c',weight:5,opacity:0.85}).addTo(this.map);
},

updateLine(){
if(!this.map)return;
this.marker.setLatLng([this.pos.lat,this.pos.lon]);
this.line.setLatLngs(this.route);
this.map.setView([this.pos.lat,this.pos.lon],this.map.getZoom());
},

async getWeather(){
const now=Date.now();
if(now-this.lastWeatherCheck<60000)return;
this.lastWeatherCheck=now;

if(this.pos.lat===0){
document.getElementById('weatherCard').innerHTML='<div class="card"><div class="status warning">â³ Warte auf GPS...</div></div>';
return;
}

try{
const lat=this.pos.lat.toFixed(4);
const lon=this.pos.lon.toFixed(4);
const url=`/.netlify/functions/weather?lat=${lat}&lon=${lon}`;

console.log('ğŸŒ¦ï¸ Lade Wetter...');
const r=await fetch(url);

if(!r.ok)throw new Error('HTTP '+r.status);

const d=await r.json();
console.log('âœ… Wetter empfangen');

if(!d.current)throw new Error('Keine Daten');

const c=d.current;
const l=d.location;

this.showWeather({
temp:Math.round(c.temp_c),
feels:Math.round(c.feelslike_c),
wind:Math.round(c.wind_kph),
gusts:Math.round(c.gust_kph),
rain:c.precip_mm||0,
humidity:c.humidity,
condition:c.condition.text,
code:c.condition.code,
location:l.name+(l.region?', '+l.region:'')
});

}catch(e){
console.error('âŒ Wetter-Fehler:',e);
document.getElementById('weatherCard').innerHTML='<div class="card"><div class="status warning">ğŸŒ Wetter nicht verfÃ¼gbar</div></div>';
}
},

showWeather(w){
const warnings=[];
let critical=false;

if(w.gusts>60){warnings.push('ğŸš¨ GEFAHR: Orkanartige BÃ¶en ('+w.gusts+' km/h)! Abstieg sofort!');critical=true}
else if(w.wind>40||w.gusts>50){warnings.push('âš ï¸ WARNUNG: Starker Wind ('+w.wind+' km/h, BÃ¶en '+w.gusts+' km/h)');critical=true}
if(w.rain>10){warnings.push('ğŸŒ§ï¸ GEFAHR: Starkregen ('+w.rain.toFixed(1)+' mm)');critical=true}
else if(w.rain>5)warnings.push('ğŸŒ§ï¸ WARNUNG: Regen ('+w.rain.toFixed(1)+' mm)');
if(w.code===1087||w.code>=1273){warnings.push('â›ˆï¸ GEWITTER! Sofort geschÃ¼tzte Stelle aufsuchen!');critical=true}
if(w.temp<0&&w.rain>0){warnings.push('â„ï¸ WARNUNG: Gefrierender Regen - Vorsicht GlÃ¤tte!');critical=true}
if(w.temp<-10)warnings.push('ğŸ¥¶ KÃ„LTE-WARNUNG: '+w.temp+'Â°C - Erfrierungsgefahr!');

if(critical)this.alarm(warnings[0]);

const valley=w.temp+3;

let html='<div class="card">';
warnings.forEach(x=>html+=`<div class="alert">${x}</div>`);
html+='<div class="section-title">ğŸŒ¦ï¸ Live-Wetter â€¢ '+w.location+'</div><div class="grid">';
html+=`<div class="box blue"><div style="font-size:2.5em">ğŸ”ï¸</div><div class="label">Berg (hier)</div><strong style="font-size:2em">${w.temp}Â°C</strong><div class="label">${w.condition}</div><div class="label" style="margin-top:6px">GefÃ¼hlt ${w.feels}Â°C</div></div>`;
html+=`<div class="box ${w.wind>30?'red':'green'}"><div style="font-size:2.5em">ğŸ’¨</div><div class="label">Wind / BÃ¶en</div><strong style="font-size:1.6em">${w.wind} km/h</strong><div class="label">BÃ¶en ${w.gusts} km/h</div>${w.rain>0?`<div class="label" style="margin-top:6px">ğŸ’§ ${w.rain.toFixed(1)} mm</div>`:''}</div>`;
html+=`<div class="box green"><div style="font-size:2.5em">ğŸï¸</div><div class="label">Tal (~500m tiefer)</div><strong style="font-size:2em">~${valley}Â°C</strong><div class="label">GeschÃ¤tzt</div></div>`;
html+=`<div class="box"><div style="font-size:2.5em">ğŸ’§</div><div class="label">Luftfeuchte</div><strong style="font-size:2em">${w.humidity}%</strong></div>`;
html+='</div><div class="label" style="text-align:center;margin-top:10px;color:#999">âœ… Live â€¢ '+new Date().toLocaleTimeString('de-DE')+'</div></div>';
document.getElementById('weatherCard').innerHTML=html;
},

alarm(msg){
if(navigator.vibrate)navigator.vibrate([500,200,500,200,500]);
try{
const s=new SpeechSynthesisUtterance('Achtung! Wetterwarnung! '+msg.replace(/[ğŸš¨âš ï¸â›ˆï¸â„ï¸ğŸŒ§ï¸ğŸ¥¶]/g,''));
s.lang='de-DE';s.rate=1.1;s.volume=1;
speechSynthesis.cancel();
speechSynthesis.speak(s);
}catch(e){}
},

render(){
this.renderPos();
this.renderDist();
this.renderStats();
this.renderCompass();
this.updateLinks();
},

renderPos(){
const p=this.pos;
let html=`<div class="big-display"><div class="label">GPS-Koordinaten</div><div style="font-size:1.6em;font-weight:800;color:#667eea;margin:12px 0">${p.lat.toFixed(6)}Â°N<br>${p.lon.toFixed(6)}Â°E</div></div><div class="grid">`;
html+=`<div class="box"><div class="label">ğŸ¯ Genauigkeit</div><strong>Â±${p.acc}m</strong></div>`;
html+=`<div class="box"><div class="label">â›°ï¸ HÃ¶he</div><strong>${p.alt?Math.round(p.alt)+'m':'â€”'}</strong></div>`;
if(p.speed!==null&&p.speed>0.5)html+=`<div class="box orange"><div class="label">ğŸš¶ Speed</div><strong>${(p.speed*3.6).toFixed(1)} km/h</strong></div>`;
if(p.heading!==null){
const d=['N','NO','O','SO','S','SW','W','NW'][Math.round(p.heading/45)%8];
html+=`<div class="box"><div class="label">ğŸ§­ Richtung</div><strong>${d} (${Math.round(p.heading)}Â°)</strong></div>`;
}
html+='</div>';
document.getElementById('position').innerHTML=html;
document.getElementById('positionCard').classList.remove('hidden');
},

renderDist(){
if(this.stats.dist<=0)return;
const t=this.stats.dist>=1000?(this.stats.dist/1000).toFixed(2)+' km':Math.round(this.stats.dist)+' m';
document.getElementById('distance').textContent=t;
document.getElementById('distanceCard').classList.remove('hidden');
},

renderStats(){
if(!this.stats.start)return;
const dur=Math.floor((Date.now()-this.stats.start)/1000);
const h=Math.floor(dur/3600);
const m=Math.floor((dur%3600)/60);
const avg=this.stats.dist>0?(this.stats.dist/(dur/3600)/1000).toFixed(1):'0.0';
let html='<div class="grid">';
html+=`<div class="box green"><div class="label">â±ï¸ Zeit</div><strong>${h}h ${m}m</strong></div>`;
html+=`<div class="box green"><div class="label">âš¡ Ã˜ Tempo</div><strong>${avg} km/h</strong></div>`;
html+=`<div class="box green"><div class="label">ğŸš€ Max Speed</div><strong>${this.stats.maxSpeed.toFixed(1)} km/h</strong></div>`;
html+=`<div class="box green"><div class="label">â›°ï¸ Max HÃ¶he</div><strong>${Math.round(this.stats.maxAlt)} m</strong></div>`;
html+=`<div class="box green"><div class="label">ğŸ“ˆ Aufstieg</div><strong>${Math.round(this.stats.ascent)} m</strong></div>`;
html+=`<div class="box green"><div class="label">ğŸ“‰ Abstieg</div><strong>${Math.round(this.stats.descent)} m</strong></div>`;
html+='</div>';
document.getElementById('stats').innerHTML=html;
document.getElementById('statsCard').classList.remove('hidden');
},

updateStats(){
if(this.tracking)this.renderStats();
},

renderCompass(){
const el=document.getElementById('compass');
if(this.pos.heading!==null){
el.style.transform=`rotate(${this.pos.heading}deg)`;
el.classList.remove('hidden');
}
},

drawElevation(){
if(this.elevations.length<2)return;
const max=Math.max(...this.elevations);
const min=Math.min(...this.elevations);
const range=max-min||1;
const w=500/this.elevations.length;
let svg='<svg width="100%" height="130" viewBox="0 0 500 130" style="background:#fff;border-radius:12px">';
this.elevations.forEach((h,i)=>{
const height=((h-min)/range)*110;
svg+=`<rect x="${i*w}" y="${120-height}" width="${w-2}" height="${height}" fill="#667eea" rx="2"/>`;
});
svg+='</svg>';
svg+=`<div style="display:flex;justify-content:space-between;margin-top:12px;font-weight:700"><span style="color:#4caf50">Min: ${Math.round(min)}m</span><span style="color:#667eea">Î” ${Math.round(range)}m</span><span style="color:#f5576c">Max: ${Math.round(max)}m</span></div>`;
document.getElementById('elevation').innerHTML=svg;
document.getElementById('elevationCard').classList.remove('hidden');
},

updateLinks(){
document.getElementById('mapsBtn').href=`https://www.google.com/maps?q=${this.pos.lat},${this.pos.lon}`;
document.getElementById('mapsBtn').style.display='block';
if(this.route.length>1){
let u='https://www.google.com/maps/dir/';
this.route.forEach(p=>u+=`${p[0]},${p[1]}/`);
document.getElementById('routeBtn').href=u;
document.getElementById('routeBtn').style.display='block';
}
},

addWP(){
if(this.pos.lat===0)return;
const n=prompt('Wegpunkt-Name:',`Punkt ${this.waypoints.length+1}`);
if(!n)return;
const wp={name:n,lat:this.pos.lat,lon:this.pos.lon,alt:this.pos.alt,time:new Date().toLocaleTimeString('de-DE')};
this.waypoints.push(wp);
if(this.map){
L.marker([wp.lat,wp.lon],{icon:L.divIcon({className:'',html:'ğŸ“Œ',iconSize:[32,32]})}).addTo(this.map).bindPopup(`<strong>${wp.name}</strong><br>${wp.lat.toFixed(6)}, ${wp.lon.toFixed(6)}`);
}
this.renderWP();
},

renderWP(){
if(!this.waypoints.length)return;
let html='';
this.waypoints.forEach((w,i)=>{
html+=`<div class="waypoint-item"><strong>${i+1}. ${w.name}</strong><br><small>${w.lat.toFixed(6)}, ${w.lon.toFixed(6)}${w.alt?' â€¢ '+Math.round(w.alt)+'m':''} â€¢ ${w.time}</small></div>`;
});
document.getElementById('waypoints').innerHTML=html;
document.getElementById('wpCount').textContent=this.waypoints.length;
document.getElementById('waypointsCard').classList.remove('hidden');
},

copy(){
const t=`${this.pos.lat.toFixed(6)}, ${this.pos.lon.toFixed(6)}`;
if(navigator.clipboard){
navigator.clipboard.writeText(t).then(()=>alert(`âœ… Kopiert:\n${t}`));
}else{
alert(`Koordinaten:\n${t}`);
}
},

reset(){
if(!confirm('ACHTUNG!\n\nAlle Daten werden gelÃ¶scht.\n\nFortfahren?'))return;
this.pause();
this.route=[];
this.elevations=[];
this.waypoints=[];
this.stats={start:null,dist:0,maxSpeed:0,maxAlt:-Infinity,minAlt:Infinity,ascent:0,descent:0,lastAlt:null};
['distanceCard','statsCard','elevationCard','waypointsCard'].forEach(id=>document.getElementById(id).classList.add('hidden'));
document.getElementById('routeBtn').style.display='none';
document.getElementById('startBtn').innerHTML='ğŸ“ Live-Tracking starten';
if(this.line)this.line.setLatLngs([]);
if(this.map){
this.map.eachLayer(l=>{if(l instanceof L.Marker && l!==this.marker)this.map.removeLayer(l)});
}
this.setStatus('success','âœ… ZurÃ¼ckgesetzt');
},

openSOS(){
const a=this.pos.alt?Math.round(this.pos.alt)+'m':'?';
document.getElementById('sosCoords').innerHTML=`${this.pos.lat.toFixed(6)}Â°N, ${this.pos.lon.toFixed(6)}Â°E<br>HÃ¶he: ${a}`;
document.getElementById('sosModal').style.display='flex';
},

closeSOS(){
document.getElementById('sosModal').style.display='none';
},

sendSMS(){
const n=document.getElementById('sosPhone').value.trim();
if(!n){alert('âŒ Nummer eingeben!');return}
const m=`ğŸ†˜ NOTRUF!\n\nPosition:\n${this.pos.lat.toFixed(6)}, ${this.pos.lon.toFixed(6)}\nHÃ¶he: ${this.pos.alt?Math.round(this.pos.alt)+'m':'?'}\n\nMaps:\nhttps://www.google.com/maps?q=${this.pos.lat},${this.pos.lon}`;
window.location.href=`sms:${n}?&body=${encodeURIComponent(m)}`;
this.closeSOS();
},

call112(){
if(confirm('ğŸ“ 112 anrufen?')){
window.location.href='tel:112';
this.closeSOS();
}
},

dist(lat1,lon1,lat2,lon2){
const R=6371000;
const toRad=d=>d*Math.PI/180;
const dLat=toRad(lat2-lat1);
const dLon=toRad(lon2-lon1);
const a=Math.sin(dLat/2)**2+Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*Math.sin(dLon/2)**2;
return R*2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a));
},

setStatus(type,msg){
const el=document.getElementById('status');
el.className=`status ${type}`;
el.innerHTML=msg;
}
};

document.addEventListener('DOMContentLoaded',()=>APP.init());
</script>
</body>
</html>
