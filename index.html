<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="description" content="Professionelle GPS-Tracking App f√ºr Bergwanderungen mit Live-Wetter, Warnungen und Route-Aufzeichnung">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="GPS Bergwandern">
    <meta name="theme-color" content="#667eea">
    
    <title>GPS Bergwandern - Live Tracking</title>
    
    <link rel="apple-touch-icon" href="icon.png">
    <link rel="icon" type="image/png" href="icon.png">
    <link rel="manifest" href="manifest.json">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 15px;
            -webkit-font-smoothing: antialiased;
        }

        .container {
            max-width: 700px;
            margin: 0 auto;
            background: #fff;
            border-radius: 20px;
            padding: 25px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }

        h1 {
            color: #2c3e50;
            margin-bottom: 20px;
            font-size: 28px;
            text-align: center;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        /* iOS Warnung */
        .ios-warning {
            background: linear-gradient(135deg, #fff3cd 0%, #ffe8a1 100%);
            border-left: 5px solid #ff9800;
            padding: 18px;
            margin-bottom: 20px;
            border-radius: 12px;
            display: none;
            box-shadow: 0 4px 12px rgba(255, 152, 0, 0.2);
            animation: slideIn 0.5s ease-out;
        }

        .ios-warning.show {
            display: block;
        }

        .ios-warning strong {
            display: block;
            margin-bottom: 8px;
            font-size: 16px;
            color: #e65100;
        }

        .ios-warning small {
            color: #666;
            line-height: 1.5;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Status Box */
        .status {
            padding: 18px;
            margin-bottom: 15px;
            border-radius: 12px;
            background: #e3f2fd;
            border-left: 5px solid #2196f3;
            font-weight: 500;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(33, 150, 243, 0.2);
        }

        .status.active {
            background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%);
            border-left-color: #4caf50;
            box-shadow: 0 2px 8px rgba(76, 175, 80, 0.3);
        }

        .status.error {
            background: linear-gradient(135deg, #ffebee 0%, #ffcdd2 100%);
            border-left-color: #f44336;
            box-shadow: 0 2px 8px rgba(244, 67, 54, 0.3);
        }

        /* Wake Lock Status */
        .wake-lock-status {
            font-size: 13px;
            color: #666;
            margin-bottom: 15px;
            padding: 12px;
            background: #f5f5f5;
            border-radius: 10px;
            text-align: center;
            border: 2px dashed #ddd;
            transition: all 0.3s ease;
        }

        .wake-lock-status.active {
            background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%);
            color: #2e7d32;
            border-color: #4caf50;
            border-style: solid;
        }

        /* Buttons */
        button {
            width: 100%;
            padding: 16px;
            margin: 8px 0;
            border: none;
            border-radius: 12px;
            font-size: 17px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .btn-start {
            background: linear-gradient(135deg, #4caf50 0%, #45a049 100%);
            color: white;
        }

        .btn-start:hover:not(:disabled) {
            background: linear-gradient(135deg, #45a049 0%, #388e3c 100%);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(76, 175, 80, 0.4);
        }

        .btn-stop {
            background: linear-gradient(135deg, #f44336 0%, #d32f2f 100%);
            color: white;
        }

        .btn-stop:hover:not(:disabled) {
            background: linear-gradient(135deg, #d32f2f 0%, #c62828 100%);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(244, 67, 54, 0.4);
        }

        button:disabled {
            background: #e0e0e0 !important;
            color: #9e9e9e !important;
            cursor: not-allowed;
            transform: none !important;
            box-shadow: none !important;
        }

        button:active:not(:disabled) {
            transform: translateY(0);
        }

        /* Track Info Grid */
        .track-info {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin: 20px 0;
        }

        .info-card {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            padding: 20px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            transition: transform 0.3s ease;
        }

        .info-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.12);
        }

        .info-label {
            font-size: 12px;
            color: #666;
            text-transform: uppercase;
            margin-bottom: 8px;
            font-weight: 600;
            letter-spacing: 1px;
        }

        .info-value {
            font-size: 26px;
            font-weight: bold;
            color: #2c3e50;
            font-variant-numeric: tabular-nums;
        }

        /* Coordinates Display */
        .coordinates {
            font-size: 14px;
            color: #555;
            margin-top: 20px;
            font-family: 'Courier New', monospace;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            padding: 15px;
            border-radius: 10px;
            line-height: 1.8;
            border: 2px solid #dee2e6;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.05);
        }

        /* Map Container */
        #map {
            width: 100%;
            height: 400px;
            border-radius: 15px;
            margin: 20px 0;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            border: 3px solid #fff;
        }

        /* Download Button */
        .btn-download {
            background: linear-gradient(135deg, #2196f3 0%, #1976d2 100%);
            color: white;
            margin-top: 10px;
        }

        .btn-download:hover:not(:disabled) {
            background: linear-gradient(135deg, #1976d2 0%, #1565c0 100%);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(33, 150, 243, 0.4);
        }

        /* Responsive */
        @media (max-width: 600px) {
            .container {
                padding: 20px;
                border-radius: 15px;
            }

            h1 {
                font-size: 24px;
            }

            .track-info {
                grid-template-columns: 1fr;
                gap: 12px;
            }

            #map {
                height: 300px;
            }
        }

        /* Loading Animation */
        @keyframes pulse {
            0%, 100% {
                opacity: 1;
            }
            50% {
                opacity: 0.6;
            }
        }

        .status.active {
            animation: pulse 2s ease-in-out infinite;
        }

        /* Battery Warning */
        .battery-warning {
            background: linear-gradient(135deg, #ffe5e5 0%, #ffcccc 100%);
            border-left: 5px solid #ff5252;
            padding: 15px;
            margin: 15px 0;
            border-radius: 12px;
            font-size: 14px;
            color: #c62828;
            display: none;
        }

        .battery-warning.show {
            display: block;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>
            <span>üèîÔ∏è</span>
            <span>GPS Bergwandern</span>
        </h1>

        <!-- iOS Warnung -->
        <div class="ios-warning" id="iosWarning">
            <strong>‚ö†Ô∏è iPhone-Nutzer aufgepasst!</strong>
            iOS pausiert das Tracking bei gesperrtem Bildschirm. 
            <strong>Bitte Bildschirm w√§hrend der Wanderung aktiv lassen!</strong><br>
            <small>üí° Tipp: Unter Einstellungen ‚Üí Anzeige & Helligkeit ‚Üí Automatische Sperre 
            auf "Nie" einstellen oder l√§ngere Zeit w√§hlen.</small>
        </div>

        <!-- Battery Warning -->
        <div class="battery-warning" id="batteryWarning">
            üîã <strong>Niedriger Akkustand!</strong> Bitte Ger√§t aufladen, um Track nicht zu verlieren.
        </div>

        <!-- Status -->
        <div class="status" id="status">
            üìç Bereit zum Tracken - Tippe auf "Tracking starten"
        </div>

        <!-- Wake Lock Status -->
        <div class="wake-lock-status" id="wakeLockStatus">
            üîì Bildschirm-Sperre: Inaktiv
        </div>

        <!-- Buttons -->
        <button class="btn-start" id="startBtn">üöÄ Tracking starten</button>
        <button class="btn-stop" id="stopBtn" disabled>‚èπÔ∏è Tracking stoppen</button>
        <button class="btn-download" id="downloadBtn" disabled>üíæ Track als GPX speichern</button>

        <!-- Track Info -->
        <div class="track-info">
            <div class="info-card">
                <div class="info-label">üìè Distanz</div>
                <div class="info-value" id="distance">0.00 km</div>
            </div>
            <div class="info-card">
                <div class="info-label">‚è±Ô∏è Zeit</div>
                <div class="info-value" id="duration">00:00:00</div>
            </div>
            <div class="info-card">
                <div class="info-label">üèÉ Geschw.</div>
                <div class="info-value" id="speed">0.0 km/h</div>
            </div>
            <div class="info-card">
                <div class="info-label">üìå Punkte</div>
                <div class="info-value" id="points">0</div>
            </div>
        </div>

        <!-- Map -->
        <div id="map"></div>

        <!-- Coordinates -->
        <div class="coordinates" id="coordinates">
            üì° Warte auf GPS-Signal...<br>
            Standortzugriff muss erlaubt werden
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        // GPS Tracker Klasse
        class GPSTracker {
            constructor() {
                this.isTracking = false;
                this.watchId = null;
                this.wakeLock = null;
                this.trackPoints = [];
                this.totalDistance = 0;
                this.startTime = null;
                this.timerInterval = null;
                this.lastPosition = null;
                this.map = null;
                this.trackLayer = null;
                this.currentMarker = null;
                
                this.initMap();
            }

            // Karte initialisieren
            initMap() {
                this.map = L.map('map').setView([47.25, 16.28], 13);
                
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '¬© OpenStreetMap contributors',
                    maxZoom: 19
                }).addTo(this.map);

                this.trackLayer = L.polyline([], {
                    color: '#f44336',
                    weight: 4,
                    opacity: 0.8
                }).addTo(this.map);
            }

            // Wake Lock aktivieren
            async requestWakeLock() {
                if ('wakeLock' in navigator) {
                    try {
                        this.wakeLock = await navigator.wakeLock.request('screen');
                        this.updateWakeLockStatus(true);
                        console.log('‚úÖ Wake Lock aktiv - Bildschirm bleibt an');

                        this.wakeLock.addEventListener('release', () => {
                            console.log('‚ö†Ô∏è Wake Lock freigegeben');
                            this.updateWakeLockStatus(false);
                        });
                    } catch (err) {
                        console.error('Wake Lock Fehler:', err);
                        this.updateWakeLockStatus(false);
                    }
                } else {
                    console.warn('Wake Lock API nicht verf√ºgbar');
                    this.updateWakeLockStatus(false);
                }
            }

            // Wake Lock Status anzeigen
            updateWakeLockStatus(active) {
                const statusEl = document.getElementById('wakeLockStatus');
                if (active) {
                    statusEl.textContent = 'üîí Bildschirm-Sperre: Aktiv (Bildschirm bleibt an)';
                    statusEl.classList.add('active');
                } else {
                    statusEl.textContent = 'üîì Bildschirm-Sperre: Inaktiv (Bitte Bildschirm nicht sperren!)';
                    statusEl.classList.remove('active');
                }
            }

            // Wake Lock freigeben
            async releaseWakeLock() {
                if (this.wakeLock) {
                    await this.wakeLock.release();
                    this.wakeLock = null;
                    this.updateWakeLockStatus(false);
                }
            }

            // Batterie-Status √ºberwachen
            async monitorBattery() {
                if ('getBattery' in navigator) {
                    try {
                        const battery = await navigator.getBattery();
                        const warningEl = document.getElementById('batteryWarning');
                        
                        const updateBatteryStatus = () => {
                            if (battery.level < 0.2 && !battery.charging) {
                                warningEl.classList.add('show');
                            } else {
                                warningEl.classList.remove('show');
                            }
                        };

                        battery.addEventListener('levelchange', updateBatteryStatus);
                        battery.addEventListener('chargingchange', updateBatteryStatus);
                        updateBatteryStatus();
                    } catch (err) {
                        console.log('Battery API nicht verf√ºgbar');
                    }
                }
            }

            // Tracking starten
            async start() {
                if (this.isTracking) return;

                // Wake Lock aktivieren
                await this.requestWakeLock();
                
                // Batterie √ºberwachen
                await this.monitorBattery();

                if (!navigator.geolocation) {
                    this.updateStatus('‚ùå Geolocation wird nicht unterst√ºtzt', 'error');
                    return;
                }

                this.isTracking = true;
                this.startTime = Date.now();
                this.trackPoints = [];
                this.totalDistance = 0;
                this.lastPosition = null;

                // Karte zur√ºcksetzen
                this.trackLayer.setLatLngs([]);
                if (this.currentMarker) {
                    this.map.removeLayer(this.currentMarker);
                }

                // Timer starten
                this.startTimer();

                // GPS Tracking starten
                this.watchId = navigator.geolocation.watchPosition(
                    (position) => this.handlePosition(position),
                    (error) => this.handleError(error),
                    {
                        enableHighAccuracy: true,
                        maximumAge: 0,
                        timeout: 10000
                    }
                );

                this.updateStatus('‚úÖ Tracking aktiv - Aufzeichnung l√§uft', 'active');
                this.updateButtons();
            }

            // Tracking stoppen
            async stop() {
                if (!this.isTracking) return;

                this.isTracking = false;

                if (this.watchId) {
                    navigator.geolocation.clearWatch(this.watchId);
                    this.watchId = null;
                }

                // Timer stoppen
                this.stopTimer();

                // Wake Lock freigeben
                await this.releaseWakeLock();

                this.updateStatus(`‚èπÔ∏è Tracking gestoppt - ${this.trackPoints.length} Punkte aufgezeichnet`, '');
                this.updateButtons();
            }

            // Position verarbeiten
            handlePosition(position) {
                const { latitude, longitude, accuracy, speed, altitude } = position.coords;

                // Koordinaten anzeigen
                document.getElementById('coordinates').innerHTML = `
                    üìç <strong>Position:</strong> ${latitude.toFixed(6)}¬∞ N, ${longitude.toFixed(6)}¬∞ E<br>
                    üéØ <strong>Genauigkeit:</strong> ¬±${accuracy.toFixed(1)}m
                    ${altitude ? ` | üìè <strong>H√∂he:</strong> ${altitude.toFixed(0)}m` : ''}
                    ${speed ? ` | üèÉ <strong>Speed:</strong> ${(speed * 3.6).toFixed(1)} km/h` : ''}
                `;

                // Punkt speichern
                const point = {
                    lat: latitude,
                    lon: longitude,
                    timestamp: Date.now(),
                    accuracy: accuracy,
                    speed: speed,
                    altitude: altitude
                };

                this.trackPoints.push(point);

                // Distanz berechnen
                if (this.lastPosition) {
                    const distance = this.calculateDistance(
                        this.lastPosition.lat,
                        this.lastPosition.lon,
                        latitude,
                        longitude
                    );
                    
                    // Nur sinnvolle Distanzen addieren (Filter f√ºr GPS-Spr√ºnge)
                    if (distance < 0.1) { // max 100m zwischen Punkten
                        this.totalDistance += distance;
                    }
                }

                this.lastPosition = point;

                // Karte aktualisieren
                this.updateMap(latitude, longitude);

                // UI aktualisieren
                this.updateUI(speed);
            }

            // Karte aktualisieren
            updateMap(lat, lon) {
                // Track-Linie aktualisieren
                const latLngs = this.trackPoints.map(p => [p.lat, p.lon]);
                this.trackLayer.setLatLngs(latLngs);

                // Aktuellen Marker setzen
                if (this.currentMarker) {
                    this.map.removeLayer(this.currentMarker);
                }

                this.currentMarker = L.marker([lat, lon], {
                    icon: L.divIcon({
                        className: 'current-position',
                        html: '<div style="background: #4caf50; width: 20px; height: 20px; border-radius: 50%; border: 3px solid white; box-shadow: 0 2px 8px rgba(0,0,0,0.3);"></div>',
                        iconSize: [20, 20]
                    })
                }).addTo(this.map);

                // Karte zentrieren
                this.map.setView([lat, lon], this.map.getZoom());
            }

            // Fehlerbehandlung
            handleError(error) {
                let message = '‚ùå GPS-Fehler: ';
                switch (error.code) {
                    case error.PERMISSION_DENIED:
                        message += 'Standortzugriff verweigert - Bitte in Einstellungen erlauben';
                        break;
                    case error.POSITION_UNAVAILABLE:
                        message += 'Position nicht verf√ºgbar - Pr√ºfe GPS-Empfang';
                        break;
                    case error.TIMEOUT:
                        message += 'Zeit√ºberschreitung - Versuche es erneut';
                        break;
                    default:
                        message += 'Unbekannter Fehler';
                }
                this.updateStatus(message, 'error');
            }

            // Distanz zwischen zwei Punkten berechnen (Haversine-Formel)
            calculateDistance(lat1, lon1, lat2, lon2) {
                const R = 6371; // Erdradius in km
                const dLat = this.deg2rad(lat2 - lat1);
                const dLon = this.deg2rad(lon2 - lon1);
                const a =
                    Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                    Math.cos(this.deg2rad(lat1)) * Math.cos(this.deg2rad(lat2)) *
                    Math.sin(dLon / 2) * Math.sin(dLon / 2);
                const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
                return R * c;
            }

            deg2rad(deg) {
                return deg * (Math.PI / 180);
            }

            // Timer starten
            startTimer() {
                this.timerInterval = setInterval(() => {
                    const elapsed = Date.now() - this.startTime;
                    const hours = Math.floor(elapsed / 3600000);
                    const minutes = Math.floor((elapsed % 3600000) / 60000);
                    const seconds = Math.floor((elapsed % 60000) / 1000);
                    document.getElementById('duration').textContent =
                        `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
                }, 1000);
            }

            // Timer stoppen
            stopTimer() {
                if (this.timerInterval) {
                    clearInterval(this.timerInterval);
                    this.timerInterval = null;
                }
            }

            // UI aktualisieren
            updateUI(speed) {
                document.getElementById('distance').textContent = `${this.totalDistance.toFixed(2)} km`;
                document.getElementById('points').textContent = this.trackPoints.length;
                
                const speedKmH = speed ? (speed * 3.6) : 0;
                document.getElementById('speed').textContent = `${speedKmH.toFixed(1)} km/h`;
            }

            // Status aktualisieren
            updateStatus(message, className) {
                const statusEl = document.getElementById('status');
                statusEl.textContent = message;
                statusEl.className = 'status ' + className;
            }

            // Buttons aktualisieren
            updateButtons() {
                document.getElementById('startBtn').disabled = this.isTracking;
                document.getElementById('stopBtn').disabled = !this.isTracking;
                document.getElementById('downloadBtn').disabled = this.trackPoints.length === 0;
            }

            // Track als GPX speichern
            saveTrack() {
                if (this.trackPoints.length === 0) {
                    alert('‚ö†Ô∏è Keine Trackpunkte vorhanden! Starte erst eine Aufzeichnung.');
                    return;
                }

                const gpx = this.generateGPX();
                const blob = new Blob([gpx], { type: 'application/gpx+xml' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                const date = new Date().toISOString().slice(0, 19).replace(/:/g, '-');
                a.download = `bergwanderung_${date}.gpx`;
                a.click();
                URL.revokeObjectURL(url);

                alert(`‚úÖ Track erfolgreich gespeichert!\n\nüìä Statistik:\n‚Ä¢ ${this.trackPoints.length} GPS-Punkte\n‚Ä¢ ${this.totalDistance.toFixed(2)} km Distanz\n‚Ä¢ ${document.getElementById('duration').textContent} Dauer`);
            }

            // GPX-Datei generieren
            generateGPX() {
                const now = new Date();
                let gpx = `<?xml version="1.0" encoding="UTF-8"?>
<gpx version="1.1" creator="GPS Bergwandern App" xmlns="http://www.topografix.com/GPX/1/1" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://www.topografix.com/GPX/1/1 http://www.topografix.com/GPX/1/1/gpx.xsd">
  <metadata>
    <name>Bergwanderung ${now.toLocaleDateString('de-DE')}</name>
    <desc>GPS-Track aufgezeichnet mit GPS Bergwandern App</desc>
    <author>
      <name>GPS Bergwandern</name>
    </author>
    <time>${now.toISOString()}</time>
  </metadata>
  <trk>
    <name>Track ${now.toLocaleTimeString('de-DE')}</name>
    <desc>Distanz: ${this.totalDistance.toFixed(2)} km, Punkte: ${this.trackPoints.length}</desc>
    <trkseg>
`;
                this.trackPoints.forEach(point => {
                    gpx += `      <trkpt lat="${point.lat}" lon="${point.lon}">
        <ele>${point.altitude || 0}</ele>
        <time>${new Date(point.timestamp).toISOString()}</time>
      </trkpt>
`;
                });

                gpx += `    </trkseg>
  </trk>
</gpx>`;
                return gpx;
            }
        }

        // App initialisieren
        const tracker = new GPSTracker();

        // iOS Detection
        const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
        if (isIOS) {
            document.getElementById('iosWarning').classList.add('show');
        }

        // Event Listeners
        document.getElementById('startBtn').addEventListener('click', () => {
            tracker.start();
        });

        document.getElementById('stopBtn').addEventListener('click', () => {
            tracker.stop();
        });

        document.getElementById('downloadBtn').addEventListener('click', () => {
            tracker.saveTrack();
        });

        // Page Visibility API - Warnung wenn Tab inaktiv
        document.addEventListener('visibilitychange', () => {
            if (document.hidden && tracker.isTracking) {
                console.warn('‚ö†Ô∏è Tab ist nicht mehr sichtbar - Tracking k√∂nnte pausieren!');
            }
        });

        // Wake Lock bei Seitenwechsel neu anfordern
        document.addEventListener('visibilitychange', async () => {
            if (!document.hidden && tracker.isTracking && !tracker.wakeLock) {
                await tracker.requestWakeLock();
            }
        });

        // Service Worker registrieren (f√ºr PWA)
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('/bergwander-gps/sw.js').catch(err => {
                console.log('Service Worker Registrierung fehlgeschlagen:', err);
            });
        }
    </script>
</body>
</html>
